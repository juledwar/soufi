#!groovy

pipeline {
    agent { label 'ci-runner-bionic' }
    options {
        timeout(time:10, unit: 'MINUTES')
    }
    stages {
        stage('Build test environment') {
            steps {
                sh(script: 'tools/create-venv')
            }
        }
        stage('Build Python package') {
            steps {
                sh(script: 'tools/build-python-package')
                archiveArtifacts artifacts: '.tox/py3/log/*', fingerprint: true, onlyIfSuccessful: false, allowEmptyArchive: true
            }
        }
        stage('Publish release package to devpi') {
          steps {
            withCredentials([[$class: 'UsernamePasswordMultiBinding',
                              credentialsId: 'CPSG-soufi-devpi-postmerge',
                              usernameVariable: 'USERNAME',
                              passwordVariable: 'PASSWORD']]) {
                    sh(script: '''
                               devpi use "http://pypi.ci.ciscolabs.com/${USERNAME}/postmerge"
                               devpi login "${USERNAME}" --password="${PASSWORD}"
                               devpi upload dist/*
                               '''
                      )
            }
          }
        }
    }
}
