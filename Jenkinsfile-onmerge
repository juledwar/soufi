#!groovy

library identifier: 'mylib@master', retriever: legacySCM(scm)

pipeline {
    agent { label 'ci-runner-bionic' }
    environment {
        GITHUB_USER = 'ci-ciscolabs.gen'
    }
    options {
        timeout(time:10, unit: 'MINUTES')
    }
    stages {
        stage('Jenkins build (onemerge)') {
            steps {
                buildUtils('findIssueFromMerge')
                buildUtils('postBuildStart')
            }
        }
        stage('Build test environment') {
            steps {
                buildUtils('editBuildResult', [ comment: 'Creating venv' ])
                sh(script: 'tools/create-venv')
            }
        }
        stage('Build Python package') {
            steps {
                buildUtils('editBuildResult', [ comment: 'Building python package' ])
                sh(script: 'tools/build-python-package')
                script {
                    env.PKG = sh(returnStdout: true,
                                 script: '''
                                         tools/get-package
                                         '''
                                ).trim()
                }
                archiveArtifacts artifacts: '.tox/py3/log/*', fingerprint: true, onlyIfSuccessful: false, allowEmptyArchive: true
            }
        }
        stage('Publish postmerge package to devpi') {
          steps {
            buildUtils('editBuildResult', [ comment: 'Publishing python package' ])
            withCredentials([[$class: 'UsernamePasswordMultiBinding',
                              credentialsId: 'CPSG-soufi-devpi-postmerge',
                              usernameVariable: 'USERNAME',
                              passwordVariable: 'PASSWORD']]) {
                script {
                    env.DEVPI_URL = "https://pypi.ci.ciscolabs.com/" + \
                                    "${USERNAME}/postmerge"
                }
                sh(script: '''
                           devpi use ${DEVPI_URL}
                           devpi login "${USERNAME}" --password="${PASSWORD}"
                           devpi upload dist/*
                           '''
                  )
                buildUtils('editBuildResult', [ comment: "Python package ${PKG} published to ${DEVPI_URL}" ])
            }
          }
        }
    }
    post {
        always {
            buildUtils('editBuildResult')
        }
    }
}
